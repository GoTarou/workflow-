{% extends "base.html" %}

{% block title %}Approvals - Document Workflow System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-check-double me-2"></i>Request Approvals
        </h1>
        <p class="text-muted mb-0">Review and approve pending requests</p>
    </div>
    <div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" data-filter="all">
                All Requests
            </button>
            <button type="button" class="btn btn-outline-warning" data-filter="pending">
                Pending
            </button>
            <button type="button" class="btn btn-outline-info" data-filter="department_approved">
                Dept. Approved
            </button>
        </div>
    </div>
</div>

<!-- Approval Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="pendingCount">0</h4>
                        <small>Pending Approval</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="departmentApprovedCount">0</h4>
                        <small>Dept. Approved</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="adminApprovedCount">0</h4>
                        <small>Admin Approved</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="rejectedCount">0</h4>
                        <small>Rejected</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Requests Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Requests Requiring Approval
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="approvalsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Department</th>
                        <th>Submitter</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="approvalsTableBody">
                    <!-- Requests will be populated here -->
                </tbody>
            </table>
        </div>
        <div id="noApprovalsMessage" class="text-center py-4" style="display: none;">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">All caught up!</h5>
            <p class="text-muted">No requests are currently pending your approval.</p>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Review Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="approvalModalContent">
                <!-- Request details and approval form will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="rejectBtn">
                    <i class="fas fa-times me-2"></i>Reject
                </button>
                <button type="button" class="btn btn-success" id="approveBtn">
                    <i class="fas fa-check me-2"></i>Approve
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-times-circle me-2"></i>Reject Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please provide a reason for rejecting this request:</p>
                <textarea class="form-control" id="rejectionReason" rows="3" 
                          placeholder="Enter rejection reason..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                    <i class="fas fa-times me-2"></i>Confirm Rejection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    Are you sure you want to delete this request? 
                    <strong id="deleteRequestTitle"></strong>
                </p>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. All approval history and related data will be permanently removed.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete Request
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentRequest = null;
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    // Load approvals on page load
    loadApprovals();
    
    // Filter buttons
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            setActiveFilter(filter);
            filterRequests(filter);
        });
    });
    
    // Approval buttons
    document.getElementById('approveBtn').addEventListener('click', function() {
        approveRequest();
    });
    
    document.getElementById('rejectBtn').addEventListener('click', function() {
        showRejectionModal();
    });
    
    document.getElementById('confirmRejectBtn').addEventListener('click', function() {
        rejectRequest();
    });
});

function setActiveFilter(filter) {
    currentFilter = filter;
    
    // Update button states
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });
}

async function loadApprovals() {
    try {
        const response = await fetch('/api/requests');
        const result = await response.json();
        
        if (result.success) {
            // Also get user role information
            const userResponse = await fetch('/api/user-info');
            const userResult = await userResponse.json();
            const isAdmin = userResult.success && userResult.user.role === 'admin';
            
            displayApprovals(result.requests, isAdmin);
            updateStatistics(result.requests);
        } else {
            showError('Failed to load approvals: ' + result.error);
        }
    } catch (error) {
        showError('Failed to load approvals: ' + error.message);
    }
}

function displayApprovals(requests, isAdmin = false) {
    const tableBody = document.getElementById('approvalsTableBody');
    const noApprovalsMessage = document.getElementById('noApprovalsMessage');
    
    // Filter requests based on current filter
    let filteredRequests = requests;
    if (currentFilter === 'pending') {
        filteredRequests = requests.filter(r => r.status === 'pending');
    } else if (currentFilter === 'department_approved') {
        filteredRequests = requests.filter(r => r.status === 'department_approved');
    }
    
    if (filteredRequests.length === 0) {
        tableBody.innerHTML = '';
        noApprovalsMessage.style.display = 'block';
        return;
    }
    
    noApprovalsMessage.style.display = 'none';
    
    tableBody.innerHTML = filteredRequests.map(request => `
        <tr>
            <td><span class="badge bg-secondary">#${request.id}</span></td>
            <td>
                <strong>${request.title}</strong>
                <br><small class="text-muted">${request.message.substring(0, 100)}${request.message.length > 100 ? '...' : ''}</small>
            </td>
            <td>
                <span class="badge bg-info">${request.department}</span>
            </td>
            <td>${request.submitter}</td>
            <td>${getStatusBadge(request.status)}</td>
            <td>${getPriorityBadge(request.priority)}</td>
            <td>
                <small class="text-muted">
                    ${new Date(request.created_at).toLocaleDateString()}
                </small>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="reviewRequest(${request.id})">
                    <i class="fas fa-eye me-1"></i>Review
                </button>
                ${isAdmin ? `
                <button class="btn btn-sm btn-outline-danger ms-1" onclick="confirmDeleteRequest(${request.id}, '${request.title.replace(/'/g, "\\'")}')">
                    <i class="fas fa-trash"></i>
                </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

function filterRequests(filter) {
    setActiveFilter(filter);
    loadApprovals(); // Reload with new filter
}

function getStatusBadge(status) {
    const statusConfig = {
        'pending': 'bg-warning',
        'department_approved': 'bg-info',
        'admin_approved': 'bg-success',
        'rejected': 'bg-danger',
        'completed': 'bg-secondary'
    };
    
    return `<span class="badge ${statusConfig[status] || 'bg-secondary'}">${status.replace('_', ' ').toUpperCase()}</span>`;
}

function getPriorityBadge(priority) {
    const priorityConfig = {
        'low': 'bg-secondary',
        'normal': 'bg-info',
        'high': 'bg-warning',
        'urgent': 'bg-danger'
    };
    
    return `<span class="badge ${priorityConfig[priority] || 'bg-secondary'}">${priority.toUpperCase()}</span>`;
}

function updateStatistics(requests) {
    const stats = {
        pending: 0,
        departmentApproved: 0,
        adminApproved: 0,
        rejected: 0
    };
    
    requests.forEach(request => {
        switch (request.status) {
            case 'pending':
                stats.pending++;
                break;
            case 'department_approved':
                stats.departmentApproved++;
                break;
            case 'admin_approved':
                stats.adminApproved++;
                break;
            case 'rejected':
                stats.rejected++;
                break;
        }
    });
    
    document.getElementById('pendingCount').textContent = stats.pending;
    document.getElementById('departmentApprovedCount').textContent = stats.departmentApproved;
    document.getElementById('adminApprovedCount').textContent = stats.adminApproved;
    document.getElementById('rejectedCount').textContent = stats.rejected;
}

async function reviewRequest(requestId) {
    try {
        const response = await fetch(`/api/requests/${requestId}`);
        const result = await response.json();
        
        if (result.success) {
            currentRequest = result.request;
            displayApprovalForm(result.request);
            const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
            modal.show();
        } else {
            showError('Failed to load request details: ' + result.error);
        }
    } catch (error) {
        showError('Failed to load request details: ' + error.message);
    }
}

function displayApprovalForm(request) {
    const content = document.getElementById('approvalModalContent');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h6>Request Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Title:</strong></td><td>${request.title}</td></tr>
                    <tr><td><strong>Department:</strong></td><td>${getStatusBadge(request.department)}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>${getStatusBadge(request.status)}</td></tr>
                    <tr><td><strong>Priority:</strong></td><td>${getPriorityBadge(request.priority)}</td></tr>
                    <tr><td><strong>Submitter:</strong></td><td>${request.submitter}</td></tr>
                    <tr><td><strong>Submitted:</strong></td><td>${new Date(request.created_at).toLocaleString()}</td></tr>
                </table>
                
                <h6 class="mt-3">Request Message</h6>
                <div class="border rounded p-3 bg-light">
                    ${request.message}
                </div>
            </div>
            <div class="col-md-4">
                <h6>Approval History</h6>
                <div class="timeline">
                    ${request.approvals.map(approval => `
                        <div class="timeline-item">
                            <div class="timeline-marker ${approval.action === 'approve' ? 'bg-success' : approval.action === 'reject' ? 'bg-danger' : 'bg-secondary'}"></div>
                            <div class="timeline-content">
                                <small class="text-muted">${new Date(approval.created_at).toLocaleString()}</small>
                                <p class="mb-1"><strong>${approval.approver}</strong> ${approval.action}ed</p>
                                ${approval.comments ? `<small class="text-muted">${approval.comments}</small>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <h6 class="mt-3">Your Decision</h6>
                <div class="mb-3">
                    <label for="approvalComments" class="form-label">Comments (Optional)</label>
                    <textarea class="form-control" id="approvalComments" rows="3" 
                              placeholder="Add any comments about your decision..."></textarea>
                </div>
            </div>
        </div>
    `;
}

function showRejectionModal() {
    const approvalModal = bootstrap.Modal.getInstance(document.getElementById('approvalModal'));
    approvalModal.hide();
    
    const rejectionModal = new bootstrap.Modal(document.getElementById('rejectionModal'));
    rejectionModal.show();
}

async function approveRequest() {
    if (!currentRequest) return;
    
    const comments = document.getElementById('approvalComments')?.value || '';
    
    try {
        const response = await fetch(`/api/requests/${currentRequest.id}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'approve',
                comments: comments
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Request approved successfully!');
            
            // Close modal and reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('approvalModal'));
            modal.hide();
            
            loadApprovals();
        } else {
            showError('Failed to approve request: ' + result.error);
        }
    } catch (error) {
        showError('Failed to approve request: ' + error.message);
    }
}

async function rejectRequest() {
    if (!currentRequest) return;
    
    const reason = document.getElementById('rejectionReason').value.trim();
    
    if (!reason) {
        showError('Please provide a reason for rejection.');
        return;
    }
    
    try {
        const response = await fetch(`/api/requests/${currentRequest.id}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'reject',
                comments: reason
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Request rejected successfully!');
            
            // Close modals and reload
            const rejectionModal = bootstrap.Modal.getInstance(document.getElementById('rejectionModal'));
            rejectionModal.hide();
            
            loadApprovals();
        } else {
            showError('Failed to reject request: ' + result.error);
        }
    } catch (error) {
        showError('Failed to reject request: ' + error.message);
    }
}

function showSuccess(message) {
    // You can implement a toast notification system here
    alert('Success: ' + message);
}

function showError(message) {
    // You can implement a toast notification system here
    alert('Error: ' + message);
}

// Function to show delete confirmation modal
function confirmDeleteRequest(requestId, requestTitle) {
    // Set the request title in the modal
    document.getElementById('deleteRequestTitle').textContent = requestTitle;
    
    // Set the request ID on the confirm button
    document.getElementById('confirmDeleteBtn').setAttribute('data-request-id', requestId);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

// Function to delete the request
async function deleteRequest(requestId) {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const originalText = confirmBtn.innerHTML;
    
    try {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
        
        const response = await fetch(`/api/requests/${requestId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Request deleted successfully!');
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
            
            // Reload the approvals
            loadApprovals();
        } else {
            showError('Failed to delete request: ' + result.error);
        }
        
    } catch (error) {
        showError('Failed to delete request: ' + error.message);
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
    }
}

// Add event listener for delete confirmation modal
document.addEventListener('DOMContentLoaded', function() {
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-request-id');
            if (requestId) {
                deleteRequest(requestId);
            }
        });
    }
});
</script>

<style>
.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 3px #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid #dee2e6;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: -24px;
    top: 12px;
    width: 1px;
    height: calc(100% + 8px);
    background: #dee2e6;
}

.timeline-item:last-child:before {
    display: none;
}

.btn-group .btn.active {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>
{% endblock %}
